
.. _x86-boot-process:

========================
The CHB x86 boot process
========================

General process
===============

Stage 1 is responsible for loading and passing control to stage 2, which in 
turn obtains information through BIOS interrupts, locates the kernel in the 
FS, loads it, and passes control to it.

CHB boot diagram
~~~~~~~~~~~~~~~~

.. code-block:: text

    stage1  -->  loader  -->  kernel

Stage1 (bootblock)
==================

Embebed variables
~~~~~~~~~~~~~~~~~

**'loader_packet'**

It contains the beginning of the disk address packet used in 'stage1' 
to load the 'loader' and has the first two bytes of the packet, size 
and reserved.

**'loader_size'**

Describes the size in sectors of the 'loader' (auto-generated by ./size_test.sh)

**'loader_offset'**

Offset to load program.

**'loader_segment'**

Segment to load program.

**'loader_lba'**

It is the location of the program on the disk, usually in the second sector 
after the MBR.

**'force_lba'**

Force the disk into LBA mode if the BIOS did not correctly report the supported 
mode. default=1

**'boot_drive'**

Save the initial value of %dl.

**'sectors'**

Save sectors per track (SPT), reported by INT13,8.

**'heads'**

Save heads per cylinder (HPC), reported by INT13,8.

**'cylinders'**

Save number of cylinder in the drive, reported by INT13,8.

Philosophy
~~~~~~~~~~

#. Jump afther BPB (bios parameter block)
#. Long jump 07c0:0 instead of 0:7c00.
#. Setup stack and data registers.
#. Test if BIOS support LBA or CHS mode for boot device.
#. Load 'loader' program starting from absolute address 0x8000 (default)
#. Long jump to 'loader' localization.

Loader
======

Binary convention (compatibility)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

CHB uses a header to run. This header contains important information 
for both startup and build processes. Two fields are crucial in 
execution time: 'size' and 'magic'. 'size' checks the header size for 
the compiled version, and 'magic' must always be '0x93A76FD8'.

These two fields ensure forward and backward compatibility when 
running the C section of the loader.

NOTE: 'loader.S' is written in a very specific way. It sets the header 
to the absolute address 0x8004 by default and reserves the first 100 
bytes of the file for information that can be stored in future versions.

Header size in each version
~~~~~~~~~~~~~~~~~~~~~~~~~~~

    **'0x5C'**: for version 0.06

Header
~~~~~~

The following is the definition of the header structure.

.. code-block:: C

    struct loader_hdr {
        u32t magic;
        u32t size;
        u8t drive_number;
        u8t version_num[3];
        char version[16];
        char first_boot[32];
        char second_boot[32];
        
        /* reserved: not implemented yet! */
    };
    
**'magic'**

CHB magic number, must be '0x93A76FD8' for sucessful load.

**'size'**

Header size.

**'drive_number'**

Reported disk number (BIOS)

**'version_num'**

Version number (byte 0: Major, byte 1: Minor, byte 2: Revision)

**'version'**

Version string.

**'first_boot'**

The first boot option is the variable that CHB uses to locate the kernel 
in the FS; it can be edited as needed but must have a maximum size of 32.

**'second_boot'**

Second boot option TODO: Not implemented.

Philosophy 
~~~~~~~~~~

#. Call to C 'loader' function.
#. Initialize video system.
#. Check magic number and size of header.
#. Obtain memory info
#. Start the disk where CHB was booted 
#. Push FAT12 driver in memory
#. Load kernel in FS (according **'first_boot'** definition)
#. Pass obtained info to kernel.
#. Execute kernel
